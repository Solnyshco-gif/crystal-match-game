<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crystal Match ULTRA</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --c:45px; --g:35px; }
        * { margin:0; padding:0; box-sizing:border-box; user-select:none; touch-action: manipulation; }
        body { background:var(--bg); color:#fff; font-family:Arial; overflow:hidden; height:100vh; }

        #loader { position:fixed; inset:0; background:var(--bg); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:20px; transition:opacity .6s; }
        .logo { width:80px; height:80px; background:radial-gradient(#FFD166,#FF6B6B); border-radius:50%; box-shadow:0 0 30px #FFD166; animation:p 1.5s infinite; }
        .loader-bar { width:200px; height:4px; background:#fff3; border-radius:2px; overflow:hidden; }
        .loader-fill { height:100%; background:#FFD166; width:0%; transition:width .3s; }

        .container { display:none; flex-direction:column; align-items:center; padding:10px; height:100%; }
        .header { display:flex; justify-content:space-between; width:100%; max-width:500px; background:#fff1; backdrop-filter:blur(10px); border-radius:20px; padding:15px; box-shadow:0 8px 32px #0003; }
        .stats { display:flex; flex-direction:column; gap:5px; font-weight:bold; font-size:14px; }
        .stat-value { background:#fff2; padding:4px 12px; border-radius:15px; min-width:60px; text-align:center; }

        #game-board { display:grid; grid-template-columns:repeat(8,1fr); gap:4px; background:#0003; border-radius:15px; padding:8px; position:relative; }
        .cell { width:var(--c); height:var(--c); background:#fff1; border-radius:12px; display:flex; align-items:center; justify-content:center; cursor:pointer; overflow:hidden; position:relative; }
        .gem { width:var(--g); height:var(--g); box-shadow:0 4px 15px #0003; transition:all .6s cubic-bezier(.2,.8,.3,1); position:relative; z-index:1; }
        .gem::after { content:''; position:absolute; inset:2px; background:linear-gradient(135deg,#fff4,transparent); border-radius:8px; }
        .gem.selected { transform:scale(1.35); box-shadow:0 0 35px gold, 0 0 60px #ff0; z-index:10; }

        .gem-1 { clip-path: circle(50%); background:linear-gradient(135deg,#FF6B6B,#FF8E8E); }
        .gem-2 { clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%); background:linear-gradient(135deg,#4ECDC4,#88D9E6); }
        .gem-3 { clip-path: polygon(50% 0%, 100% 100%, 0% 100%); background:linear-gradient(135deg,#FFD166,#FFE8A3); }
        .gem-4 { clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%); background:linear-gradient(135deg,#06D6A0,#6AFFD6); }
        .gem-5 { clip-path: circle(45%); background:linear-gradient(135deg,#118AB2,#5BC0EB); }
        .gem-6 { clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); background:linear-gradient(135deg,#9B5DE5,#C78FFF); }
        .gem-7 { clip-path: polygon(50% 0%, 90% 38%, 90% 80%, 50% 100%, 10% 80%, 10% 38%); background:linear-gradient(135deg,#F15BB5,#FFA8E0); }

        @keyframes p { 0%,100% {transform:scale(1)} 50% {transform:scale(1.1)} }
        @keyframes e { to {transform:scale(0);opacity:0} }
        @keyframes f { 0% {transform:translateY(-300px);opacity:0} 70% {transform:translateY(10px)} 100% {transform:translateY(0);opacity:1} }
        @keyframes slide { 0% {transform:translateX(var(--dx)) translateY(-30px)} 100% {transform:translateX(0) translateY(0)} }
        @keyframes s { 0% {transform:scale(0) rotate(-360deg);opacity:0} 70% {transform:scale(1.2)} 100% {transform:scale(1);opacity:1} }
        @keyframes shine { 0% {box-shadow:0 0 20px gold} 100% {box-shadow:0 0 40px #ff0, 0 0 60px #ff0} }
        @keyframes particle { 0% {transform:scale(1);opacity:1} 100% {transform:translate(var(--tx),var(--ty)) scale(0);opacity:0} }

        .gem.exploding { animation:e .7s cubic-bezier(.2,.8,.3,1) forwards; }
        .gem.falling { animation:f .8s cubic-bezier(.2,.8,.3,1); }
        .gem.sliding { animation:slide .6s cubic-bezier(.2,.8,.3,1); }
        .gem.spawning { animation:s .7s cubic-bezier(.2,.8,.3,1); }
        .gem.shine { animation:shine .6s ease-out; }

        .particle { position:absolute; width:6px; height:6px; background:gold; border-radius:50%; pointer-events:none; z-index:100; animation:particle .9s ease-out forwards; }

        .controls { display:flex; gap:10px; margin-top:15px; flex-wrap:wrap; justify-content:center; }
        .btn { padding:12px 18px; border:none; border-radius:20px; font-weight:bold; cursor:pointer; background:linear-gradient(135deg,#FF6B6B,#FF8E8E); color:#fff; box-shadow:0 8px 20px #f661; transition:all .3s; font-size:13px; }
        .btn:hover { transform:translateY(-2px); }
        .btn-premium { background:linear-gradient(135deg,#FFD166,#FFE8A3); color:#333; }
        .btn-leader { background:linear-gradient(135deg,#4ECDC4,#88D9E6); }
        .btn-bonus { background:linear-gradient(135deg,#06D6A0,#6AFFD6); }

        .progress-bar { height:12px; background:linear-gradient(90deg,#FF6B6B,#4ECDC4,#118AB2); border-radius:10px; width:0%; transition:width .7s ease; }

        .modal { position:fixed; inset:0; background:#0008; display:flex; align-items:center; justify-content:center; z-index:1000; backdrop-filter:blur(10px); }
        .modal-content { background:var(--bg); padding:30px; border-radius:25px; text-align:center; max-width:90%; box-shadow:0 25px 50px #0005; animation:m .5s; max-height:80vh; overflow-y:auto; }
        @keyframes m { from {transform:scale(.7) translateY(50px);opacity:0} }

        .lb-item { display:flex; justify-content:space-between; padding:10px 15px; background:#fff1; border-radius:12px; margin:6px 0; font-weight:bold; }
        .lb-rank { font-size:18px; color:#FFD166; }

        .bonus-popup { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:linear-gradient(135deg,#FFD166,#FF6B6B); color:#333; padding:20px 30px; border-radius:20px; font-weight:bold; font-size:18px; box-shadow:0 20px 40px #0005; z-index:2000; animation:bonus-pop .8s; }
        @keyframes bonus-pop { 0% {transform:translate(-50%,-50%) scale(0.5);opacity:0} 60% {transform:translate(-50%,-50%) scale(1.1)} 100% {transform:translate(-50%,-50%) scale(1);opacity:1} }

        .hidden { display:none; }
        @media (max-width:500px) { :root {--c:35px;--g:28px} .btn {padding:10px 14px;font-size:12px;} }
    </style>
</head>
<body>

<div id="loader">
    <div class="logo"></div>
    <div style="font-size:18px;font-weight:bold;background:linear-gradient(90deg,#FFD166,#FF6B6B);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">
        CRYSTAL MATCH ULTRA
    </div>
    <div class="loader-bar"><div class="loader-fill" id="fill"></div></div>
</div>

<div class="container" id="game">
    <div class="header">
        <div class="stats">
            <div>Очки: <span class="stat-value" id="score">0</span></div>
            <div>Ходы: <span class="stat-value" id="moves">25</span></div>
            <div>Уровень: <span class="stat-value" id="lvl">1</span></div>
        </div>
        <div class="stats">
            <div>Цель: <span class="stat-value" id="target">1000</span></div>
            <div>Комбо: <span class="stat-value" id="combo">x1</span></div>
        </div>
    </div>

    <div style="background:#fff05;border-radius:25px;padding:15px;box-shadow:0 20px 40px #0004;backdrop-filter:blur(15px);">
        <div id="game-board"></div>
    </div>

    <div style="width:100%;max-width:500px;margin:15px 0;background:#fff1;border-radius:15px;padding:8px;">
        <div class="progress-bar" id="prog"></div>
    </div>

    <div class="controls">
        <button class="btn btn-bonus" id="bonus">Бонус</button>
        <button class="btn" id="hint">Подсказка</button>
        <button class="btn btn-leader" id="leader">ТОП-10</button>
        <button class="btn btn-premium" id="prem">ПРЕМИУМ</button>
        <button class="btn" id="restart">Заново</button>
    </div>
</div>

<div id="win" class="modal hidden">
    <div class="modal-content">
        <h2>Победа!</h2>
        <p>Очки: <span id="fscore">0</span></p>
        <button class="btn" id="next">Далее</button>
    </div>
</div>

<div id="lb-modal" class="modal hidden">
    <div class="modal-content">
        <h2>Лидерборд ТОП-10</h2>
        <div id="lb-list"></div>
        <button class="btn" id="close-lb">Закрыть</button>
    </div>
</div>

<script>
const tg = window.Telegram?.WebApp || { expand: () => {}, showPopup: () => {} }; tg.expand();
const S=8, T=7;
const TARGETS=[1000,2500,5000,10000,20000];
const MOVES=[25,22,20,18,15];
const USER_NAME = (tg.initDataUnsafe?.user?.first_name) || "Игрок";

const st = {b:[],sc:0,mv:25,lv:1,tg:1000,cb:1,cm:1,sel:null,an:false,st:false};
const el = {
    l:document.getElementById('loader'), f:document.getElementById('fill'),
    g:document.getElementById('game'), b:document.getElementById('game-board'),
    sc:document.getElementById('score'), mv:document.getElementById('moves'),
    lv:document.getElementById('lvl'), tg:document.getElementById('target'),
    cb:document.getElementById('combo'), pr:document.getElementById('prog'),
    win:document.getElementById('win'), fs:document.getElementById('fscore'),
    bonus:document.getElementById('bonus'), hint:document.getElementById('hint'),
    leader:document.getElementById('leader'), prem:document.getElementById('prem'),
    rest:document.getElementById('restart'), next:document.getElementById('next'),
    lbModal:document.getElementById('lb-modal'), lbList:document.getElementById('lb-list'),
    closeLb:document.getElementById('close-lb')
};

function rnd(){return Math.floor(Math.random()*T)+1}
function sleep(ms){return new Promise(r=>setTimeout(r,ms))}

// === ЛИДЕРБОРД, БОНУСЫ, СОХРАНЕНИЕ — без изменений ===
const LB = { /* ... как раньше ... */ };
const BONUS = { /* ... как раньше ... */ };
function save(){ /* ... */ }
function load(){ /* ... */ }

// === ЭФФЕКТЫ ===
function createParticles(cell, color = 'gold'){
    const r = cell.getBoundingClientRect();
    const cx = r.left + r.width/2, cy = r.top + r.height/2;
    for(let i=0;i<12;i++){
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.background = color;
        p.style.left = cx + 'px'; p.style.top = cy + 'px';
        const a = Math.random()*Math.PI*2, d = 40 + Math.random()*80;
        p.style.setProperty('--tx', Math.cos(a)*d + 'px');
        p.style.setProperty('--ty', Math.sin(a)*d + 'px');
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 900);
    }
}

// === ИГРА ===
function initBoard(){ /* ... */ }
function matchAt(r,c,t){ /* ... */ }
function hasMoves(){ /* ... */ }
function swap(r1,c1,r2,c2){[st.b[r1][c1],st.b[r2][c2]]=[st.b[r2][c2],st.b[r1][c1]]}

function render(){
    el.b.innerHTML='';
    for(let r=0;r<S;r++)for(let c=0;c<S;c++){
        if(!st.b[r][c])continue;
        const cell=document.createElement('div'); cell.className='cell'; cell.dataset.r=r; cell.dataset.c=c;
        const gem=document.createElement('div'); gem.className=`gem gem-${st.b[r][c]}`;
        cell.appendChild(gem); el.b.appendChild(cell);
        cell.onclick=()=>click(r,c);
    }
}
function click(r,c){ /* ... как раньше ... */ }
function sel(r,c){ /* ... */ }
function clear(){ /* ... */ }

// === УЛЬТРА-АНИМАЦИЯ ОБМЕНА ===
async function swapGems(g1, g2) { /* ... как раньше ... */ }

// === НОВАЯ ФУНКЦИЯ: ПАДЕНИЕ + СДВИГ С ДУГОЙ ===
async function drop() {
    let moved = false;
    const animPromises = [];

    // Вертикальное падение
    for (let c = 0; c < S; c++) {
        let writePos = S - 1;
        for (let r = S - 1; r >= 0; r--) {
            if (st.b[r][c]) {
                if (r !== writePos) {
                    st.b[writePos][c] = st.b[r][c];
                    st.b[r][c] = 0;
                    moved = true;

                    const cell = document.querySelector(`[data-r="${writePos}"][data-c="${c}"]`);
                    const gem = cell?.querySelector('.gem');
                    if (gem) {
                        gem.classList.add('falling');
                        createParticles(cell, '#FFD166');
                    }
                }
                writePos--;
            }
        }
    }

    // Горизонтальный сдвиг (если дырки слева/справа)
    for (let r = 0; r < S; r++) {
        let emptyCount = 0;
        for (let c = 0; c < S; c++) {
            if (!st.b[r][c]) emptyCount++;
            else if (emptyCount > 0) {
                st.b[r][c - emptyCount] = st.b[r][c];
                st.b[r][c] = 0;
                moved = true;

                const cell = document.querySelector(`[data-r="${r}"][data-c="${c - emptyCount}"]`);
                const gem = cell?.querySelector('.gem');
                if (gem) {
                    gem.style.setProperty('--dx', `${emptyCount * 50}px`);
                    gem.classList.add('sliding');
                    createParticles(cell, '#4ECDC4');
                }
            }
        }
    }

    if (moved) {
        render();
        await sleep(800);
    }
    return moved;
}

async function spawn(){
    let sp=false;
    for(let r=0;r<S;r++)for(let c=0;c<S;c++)if(!st.b[r][c]){
        st.b[r][c]=rnd(); sp=true;
        setTimeout(()=>{const cell=document.querySelector(`[data-r="${r}"][data-c="${c}"]`); const gem=cell?.querySelector('.gem'); if(gem){gem.classList.add('spawning'); createParticles(cell, '#4ECDC4');}},100);
    }
    if(sp){render();await sleep(700)}
}

async function proc(m){
    st.cm+=0.2; st.cb=Math.floor(st.cm*10)/10;
    let sc=0;
    m.forEach(mm=>{
        sc+=mm.l*100*st.cb;
        for(let i=0;i<mm.l;i++){
            const rr=mm.h?mm.r:mm.r+i, cc=mm.h?mm.c+i:mm.c;
            explode(rr,cc);
        }
    });
    st.sc+=Math.floor(sc); await sleep(700);
    await drop(); await spawn();
    const n=find(); if(n.length)await proc(n); else{st.cb=1;st.cm=1}
    ui(); save();
}

// === ОСТАЛЬНОЕ: ui(), win(), next(), reset(), загрузка ===
function ui(){ /* ... */ }
function win(){ /* ... */ }
function next(){ /* ... */ }
function reset(){ /* ... */ }

/* ЗАГРУЗКА */
load();
setTimeout(() => {
    el.f.style.width = '100%';
    initBoard(); render(); ui();
    el.g.style.display='flex'; el.l.style.opacity='0';
    setTimeout(()=>{el.l.remove(); BONUS.claim();},600);
}, 100);

/* КНОПКИ */
el.bonus.onclick=()=>{ if(!BONUS.claim()) alert('Бонус уже получен!'); };
el.hint.onclick=()=>{ alert('Подсказка: ищите 3+ в ряд!'); };
el.rest.onclick=reset;
el.next.onclick=next;
el.leader.onclick=()=>{ LB.show(); el.lbModal.classList.remove('hidden'); };
el.closeLb.onclick=()=>{ el.lbModal.classList.add('hidden'); };
el.prem.onclick=()=>tg.showPopup?.({title:'Премиум',message:'Без рекламы!',buttons:[{type:'default',text:'299₽/мес'},{type:'cancel'}]}) || alert('Премиум недоступен');

</script>
</body>
</html>
