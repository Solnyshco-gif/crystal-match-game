<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crystal Match</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --c:45px; --g:35px; }
        * { margin:0; padding:0; box-sizing:border-box; user-select:none; touch-action: manipulation; }
        body { background:var(--bg); color:#fff; font-family:Arial; overflow:hidden; height:100vh; }

        #loader { position:fixed; inset:0; background:var(--bg); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:20px; transition:opacity .6s; }
        .logo { width:80px; height:80px; background:radial-gradient(#FFD166,#FF6B6B); border-radius:50%; box-shadow:0 0 30px #FFD166; animation:p 1.5s infinite; }
        .loader-bar { width:200px; height:4px; background:#fff3; border-radius:2px; overflow:hidden; }
        .loader-fill { height:100%; background:#FFD166; width:0%; transition:width .3s; }

        .container { display:none; flex-direction:column; align-items:center; padding:10px; height:100%; }
        .header { display:flex; justify-content:space-between; width:100%; max-width:500px; background:#fff1; backdrop-filter:blur(10px); border-radius:20px; padding:15px; box-shadow:0 8px 32px #0003; }
        .stats { display:flex; flex-direction:column; gap:5px; font-weight:bold; font-size:14px; }
        .stat-value { background:#fff2; padding:4px 12px; border-radius:15px; min-width:60px; text-align:center; }

        #game-board { display:grid; grid-template-columns:repeat(8,1fr); gap:4px; background:#0003; border-radius:15px; padding:8px; }
        .cell { width:var(--c); height:var(--c); background:#fff1; border-radius:12px; display:flex; align-items:center; justify-content:center; cursor:pointer; overflow:hidden; }
        .gem { width:var(--g); height:var(--g); border-radius:10px; box-shadow:0 4px 15px #0003; transition:all .3s; position:relative; }
        .gem::after { content:''; position:absolute; inset:2px; background:linear-gradient(135deg,#fff4,transparent); border-radius:8px; }
        .gem.selected { transform:scale(1.2); box-shadow:0 0 25px gold; z-index:10; }

        .gem-1 { background:linear-gradient(135deg,#FF6B6B,#FF8E8E); }
        .gem-2 { background:linear-gradient(135deg,#4ECDC4,#88D9E6); }
        .gem-3 { background:linear-gradient(135deg,#FFD166,#FFE8A3); }
        .gem-4 { background:linear-gradient(135deg,#06D6A0,#6AFFD6); }
        .gem-5 { background:linear-gradient(135deg,#118AB2,#5BC0EB); }
        .gem-6 { background:linear-gradient(135deg,#9B5DE5,#C78FFF); }
        .gem-7 { background:linear-gradient(135deg,#F15BB5,#FFA8E0); }

        @keyframes p { 0%,100% {transform:scale(1)} 50% {transform:scale(1.1)} }
        @keyframes e { to {transform:scale(0);opacity:0} }
        @keyframes f { from {transform:translateY(-150px);opacity:0} }
        @keyframes s { 0% {transform:scale(0) rotate(-180deg)} 70% {transform:scale(1.1)} }

        .gem.exploding { animation:e .5s forwards; }
        .gem.falling { animation:f .5s; }
        .gem.spawning { animation:s .5s; }

        .controls { display:flex; gap:15px; margin-top:15px; }
        .btn { padding:12px 25px; border:none; border-radius:20px; font-weight:bold; cursor:pointer; background:linear-gradient(135deg,#FF6B6B,#FF8E8E); color:#fff; box-shadow:0 8px 20px #f661; transition:.3s; }
        .btn:hover { transform:translateY(-2px); }
        .btn-premium { background:linear-gradient(135deg,#FFD166,#FFE8A3); color:#333; }

        .progress-bar { height:12px; background:linear-gradient(90deg,#FF6B6B,#4ECDC4,#118AB2); border-radius:10px; width:0%; transition:.5s; }

        .modal { position:fixed; inset:0; background:#0008; display:flex; align-items:center; justify-content:center; z-index:1000; backdrop-filter:blur(10px); }
        .modal-content { background:var(--bg); padding:30px; border-radius:25px; text-align:center; max-width:90%; box-shadow:0 25px 50px #0005; animation:m .5s; }
        @keyframes m { from {transform:scale(.7) translateY(50px);opacity:0} }

        .hidden { display:none; }
        @media (max-width:500px) { :root {--c:35px;--g:28px} }
    </style>
</head>
<body>

<div id="loader">
    <div class="logo"></div>
    <div style="font-size:18px;font-weight:bold;background:linear-gradient(90deg,#FFD166,#FF6B6B);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">
        CRYSTAL MATCH
    </div>
    <div class="loader-bar"><div class="loader-fill" id="fill"></div></div>
</div>

<div class="container" id="game">
    <div class="header">
        <div class="stats">
            <div>Очки: <span class="stat-value" id="score">0</span></div>
            <div>Ходы: <span class="stat-value" id="moves">25</span></div>
            <div>Уровень: <span class="stat-value" id="lvl">1</span></div>
        </div>
        <div class="stats">
            <div>Цель: <span class="stat-value" id="target">1000</span></div>
            <div>Комбо: <span class="stat-value" id="combo">x1</span></div>
        </div>
    </div>

    <div style="background:#fff05;border-radius:25px;padding:15px;box-shadow:0 20px 40px #0004;backdrop-filter:blur(15px);">
        <div id="game-board"></div>
    </div>

    <div style="width:100%;max-width:500px;margin:15px 0;background:#fff1;border-radius:15px;padding:8px;">
        <div class="progress-bar" id="prog"></div>
    </div>

    <div class="controls">
        <button class="btn" id="hint">Подсказка</button>
        <button class="btn btn-premium" id="prem">ПРЕМИУМ</button>
        <button class="btn" id="restart">Заново</button>
    </div>
</div>

<div id="win" class="modal hidden">
    <div class="modal-content">
        <h2>Победа!</h2>
        <p>Очки: <span id="fscore">0</span></p>
        <button class="btn" id="next">Далее</button>
    </div>
</div>

<script>
const tg = window.Telegram.WebApp; tg.expand();
const S=8, T=7;
const TARGETS=[1000,2500,5000,10000,20000];
const MOVES=[25,22,20,18,15];

const st = {b:[],sc:0,mv:25,lv:1,tg:1000,cb:1,cm:1,sel:null,an:false,st:false};
const el = {
    l:document.getElementById('loader'), f:document.getElementById('fill'),
    g:document.getElementById('game'), b:document.getElementById('game-board'),
    sc:document.getElementById('score'), mv:document.getElementById('moves'),
    lv:document.getElementById('lvl'), tg:document.getElementById('target'),
    cb:document.getElementById('combo'), pr:document.getElementById('prog'),
    win:document.getElementById('win'), fs:document.getElementById('fscore'),
    hint:document.getElementById('hint'), prem:document.getElementById('prem'),
    rest:document.getElementById('restart'), next:document.getElementById('next')
};

function rnd(){return Math.floor(Math.random()*T)+1}
function sleep(ms){return new Promise(r=>setTimeout(r,ms))}

// === СОХРАНЕНИЕ ===
function save(){
    const data = {lv:st.lv, sc:st.sc, mv:st.mv, tg:st.tg};
    localStorage.setItem('crystalSave', JSON.stringify(data));
}
function load(){
    const saved = localStorage.getItem('crystalSave');
    if(saved){
        const d = JSON.parse(saved);
        st.lv = d.lv || 1;
        st.sc = d.sc || 0;
        st.mv = d.mv || MOVES[st.lv-1] || 25;
        st.tg = d.tg || TARGETS[st.lv-1] || 1000;
    } else {
        st.tg = TARGETS[0];
        st.mv = MOVES[0];
    }
}

// === ИГРА ===
function initBoard(){
    st.b=Array(S).fill().map(()=>Array(S).fill(0));
    for(let r=0;r<S;r++)for(let c=0;c<S;c++){
        let t; do{t=rnd()}while(matchAt(r,c,t));
        st.b[r][c]=t;
    }
    if(!hasMoves()) initBoard();
}
function matchAt(r,c,t){return (c>1&&st.b[r][c-1]==t&&st.b[r][c-2]==t)||(r>1&&st.b[r-1][c]==t&&st.b[r-2][c]==t)}
function hasMoves(){
    for(let r=0;r<S;r++)for(let c=0;c<S;c++){
        if(c<S-1){swap(r,c,r,c+1);if(find().length){swap(r,c,r,c+1);return true}}
        if(r<S-1){swap(r,c,r+1,c);if(find().length){swap(r,c,r+1,c);return true}}
    }
    return false;
}
function swap(r1,c1,r2,c2){[st.b[r1][c1],st.b[r2][c2]]=[st.b[r2][c2],st.b[r1][c1]]}

function render(){
    el.b.innerHTML='';
    for(let r=0;r<S;r++)for(let c=0;c<S;c++){
        if(!st.b[r][c])continue;
        const cell=document.createElement('div'); cell.className='cell'; cell.dataset.r=r; cell.dataset.c=c;
        const gem=document.createElement('div'); gem.className=`gem gem-${st.b[r][c]}`;
        cell.appendChild(gem); el.b.appendChild(cell);
        cell.onclick=()=>click(r,c);
    }
}
function click(r,c){
    if(st.an||st.mv<=0)return;
    if(!st.st)st.st=true;
    const g={r,c,t:st.b[r][c]};
    if(!st.sel){st.sel=g;sel(r,c)}
    else if(Math.abs(g.r-st.sel.r)+Math.abs(g.c-st.sel.c)==1){
        st.an=true; swapGems(st.sel,g).then(ok=>{if(ok){st.mv--;ui();win();save()};st.sel=null;st.an=false});
    }else{clear();st.sel=g;sel(r,c)}
}
function sel(r,c){document.querySelector(`[data-r="${r}"][data-c="${c}"] .gem`)?.classList.add('selected')}
function clear(){document.querySelectorAll('.gem.selected').forEach(e=>e.classList.remove('selected'))}

async function swapGems(g1,g2){
    const c1=document.querySelector(`[data-r="${g1.r}"][data-c="${g1.c}"]`);
    const c2=document.querySelector(`[data-r="${g2.r}"][data-c="${g2.c}"]`);
    const r1=c1.getBoundingClientRect(), r2=c2.getBoundingClientRect();
    const dx=r2.left-r1.left, dy=r2.top-r1.top;
    const gem1=c1.querySelector('.gem'), gem2=c2.querySelector('.gem');
    gem1.style.position=gem2.style.position='fixed';
    gem1.style.left=r1.left+'px'; gem1.style.top=r1.top+'px';
    gem2.style.left=r2.left+'px'; gem2.style.top=r2.top+'px';
    gem1.style.zIndex=gem2.style.zIndex=100;
    requestAnimationFrame(()=>{gem1.style.transform=`translate(${dx}px,${dy}px)`;gem2.style.transform=`translate(${-dx}px,${-dy}px)`});
    await sleep(300);
    swap(g1.r,g1.c,g2.r,g2.c); render();
    const m=find(); if(m.length){await proc(m);return true}
    swap(g1.r,g1.c,g2.r,g2.c); render(); return false;
}

function find(){
    const m=[],v=Array(S).fill().map(()=>Array(S).fill(false));
    for(let r=0;r<S;r++)for(let c=0;c<S;c++){
        if(v[r][c]||!st.b[r][c])continue;
        const t=st.b[r][c]; let h=1,vv=1;
        while(c+h<S&&st.b[r][c+h]==t)h++;
        while(r+vv<S&&st.b[r+vv][c]==t)vv++;
        if(h>=3){m.push({r,c,l:h,h:true});for(let i=0;i<h;i++)v[r][c+i]=true}
        if(vv>=3){m.push({r,c,l:vv,h:false});for(let i=0;i<vv;i++)v[r+i][c]=true}
    }
    return m;
}

async function proc(m){
    st.cm+=0.2; st.cb=Math.floor(st.cm*10)/10;
    let sc=0;
    m.forEach(mm=>{
        sc+=mm.l*100*st.cb;
        for(let i=0;i<mm.l;i++){
            const rr=mm.h?mm.r:mm.r+i, cc=mm.h?mm.c+i:mm.c;
            explode(rr,cc);
        }
    });
    st.sc+=Math.floor(sc); await sleep(600);
    await drop(); await spawn();
    const n=find(); if(n.length)await proc(n); else{st.cb=1;st.cm=1}
    ui(); save();
}
function explode(r,c){
    const gem=document.querySelector(`[data-r="${r}"][data-c="${c}"] .gem`);
    if(gem)gem.classList.add('exploding');
    setTimeout(()=>{st.b[r][c]=0},300);
}
async function drop(){
    let mv=false;
    for(let c=0;c<S;c++){
        let p=S-1;
        for(let r=S-1;r>=0;r--){
            if(st.b[r][c]){
                if(r!==p){st.b[p][c]=st.b[r][c];st.b[r][c]=0;mv=true;
                    setTimeout(()=>{document.querySelector(`[data-r="${p}"][data-c="${c}"] .gem`)?.classList.add('falling')},50);
                }p--;
            }
        }
    }
    if(mv){render();await sleep(500)}
}
async function spawn(){
    let sp=false;
    for(let r=0;r<S;r++)for(let c=0;c<S;c++)if(!st.b[r][c]){
        st.b[r][c]=rnd(); sp=true;
        setTimeout(()=>{document.querySelector(`[data-r="${r}"][data-c="${c}"] .gem`)?.classList.add('spawning')},100);
    }
    if(sp){render();await sleep(500)}
}

function ui(){
    el.sc.textContent=st.sc; el.mv.textContent=st.mv; el.lv.textContent=st.lv;
    el.tg.textContent=st.tg; el.cb.textContent='x'+st.cb;
    el.pr.style.width=Math.min(st.sc/st.tg*100,100)+'%';
}
function win(){
    if(st.st&&st.sc>=st.tg){el.fs.textContent=st.sc;el.win.classList.remove('hidden')}
    else if(st.mv<=0&&st.st){setTimeout(()=>{alert('Ходы кончились!');reset()},500)}
}
function next(){
    st.lv++; st.tg=TARGETS[st.lv-1]||st.lv*2000;
    st.mv=MOVES[st.lv-1]||15; st.sc=0; st.cb=1; st.cm=1; st.st=false;
    initBoard(); render(); ui(); save(); el.win.classList.add('hidden');
}
function reset(){
    if(!confirm('Сбросить прогресс?')) return;
    localStorage.removeItem('crystalSave');
    st.lv=1; st.sc=0; st.mv=25; st.tg=1000; st.cb=1; st.cm=1; st.st=false;
    initBoard(); render(); ui();
}

/* ЗАЩИТА ОТ ЗУМА */
let lastTouch = 0;
document.addEventListener('touchend', e => {
    const now = Date.now();
    if (now - lastTouch < 300) e.preventDefault();
    lastTouch = now;
}, { passive: false });

/* ЗАГРУЗКА */
load();
let p=0;
const iv=setInterval(()=>{
    p+=25; el.f.style.width=Math.min(p,100)+'%';
    if(p>=100){clearInterval(iv);
        initBoard(); render(); ui();
        el.g.style.display='flex'; el.l.style.opacity='0';
        setTimeout(()=>el.l.remove(),600);
    }
},80);

/* КНОПКИ */
el.hint.onclick=()=>{/* подсказка */};
el.rest.onclick=reset;
el.next.onclick=next;
el.prem.onclick=()=>tg.showPopup({title:'Премиум',message:'Без рекламы!',buttons:[{type:'default',text:'299₽/мес'},{type:'cancel'}]});

</script>
</body>
</html>
